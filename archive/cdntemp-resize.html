<!DOCTYPE html>
<html lang="en">
	<head>
		<title>River Forest Lettuce Experiment</title>
		<meta charset="utf-8">
 	    <meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<link rel="stylesheet" href="css/mystyle.css">
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="js/d3.tip.v0.6.3.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	</head>
	<body>
		<div class="container">
	        <div class="jumbotron">
	        	<h1>River Forest Lettuce Experiment</h1>
	        	<div class="tank1Key">Tank 1</div>
	        	<div class="tank2Key">Tank 2</div>
	        	<div class="tank3Key">Tank 3</div>
	        	<div class="tank4Key">Tank 4</div>
	        </div>

	        <div class="row" id="phArea">
				<script type="text/javascript">
//Start of pH Area
//Get the Data for all pH series
				ph1graph = d3.json("php/ph1.php", function(ph1Points){
					ph2graph = d3.json("php/ph2.php", function(ph2Points){
						ph3graph = d3.json("php/ph3.php", function(ph3Points){
							ph4graph = d3.json("php/ph4.php", function(ph4Points){

//Global pH Variable Settings
								var margin = {top: 30, right: 10, bottom: 30, left: 10}
								   , width = parseInt(d3.select('#phspace').style('width'), 10)
								   , width = width - margin.left - margin.right
								   , barHeight = 20
								   , percent = d3.format('%');
								var w = 1000;
								var h = 500;
								var xPadding = 50;
								var xPadding2 = xPadding - 5;
								var yPadding = 40;
								var yPadding2 = yPadding - 5;

								var circleSize = 2.5;
								var lineStroke = 2;

								var ph1Color = "green";
								var ph2Color = "indianred";
								var ph3Color = "lightblue";
								var ph4Color = "orange";

								var phSenseLB = 3;
								var phSenseUB = 14;

								var xAxisTicks = 10;
								var yAxisTicks = phSenseUB - phSenseLB;

								var selectionTime = -1.5; //specified in hours


//Parse the Date/Time into plotable data
					//Parser Function to sort out format from MYSQL
								var timeParser = d3.time.format("%Y-%m-%d %X").parse;

//Calculate the time ranges of input data
								
								var maxdate = d3.max(ph1Points, function(d) {
									return (timeParser(d.time));
								});

            					var mindate = d3.min(ph1Points, function(d) {
									return (timeParser(d.time));
								});
								rollingSelection = d3.time.hour.offset(maxdate, selectionTime)
							//Setting the range manually
								//maxdate = timeParser("2016-05-8 17:00:00");
								//rollingSelection = timeParser("2016-05-8 16:00:00");
//filtering out data points outside the current selection time
								ph1Points = ph1Points.filter(function(d) {
									return timeParser(d.time) > rollingSelection;
								});
								ph2Points = ph2Points.filter(function(d) {
									return timeParser(d.time) > rollingSelection;
								});
								ph3Points = ph3Points.filter(function(d) {
									return timeParser(d.time) > rollingSelection;
								});
								ph4Points = ph4Points.filter(function(d) {
									return timeParser(d.time) > rollingSelection;
								});

//Filter out obvious errors in data reading
		//Filter out by Lower Bounds
								ph1Points = ph1Points.filter(function(d) {
									return +d.reading >= phSenseLB;
								});
								ph2Points = ph2Points.filter(function(d) {
									return +d.reading >= phSenseLB;
								});
								ph3Points = ph3Points.filter(function(d) {
									return +d.reading >= phSenseLB;
								});								
								ph4Points = ph4Points.filter(function(d) {
									return +d.reading >= phSenseLB;
								});
		//Filter out by Upper Bounds
								ph1Points = ph1Points.filter(function(d) {
									return +d.reading <= phSenseUB;
								});
								ph2Points = ph2Points.filter(function(d) {
									return +d.reading <= phSenseUB;
								});
								ph3Points = ph3Points.filter(function(d) {
									return +d.reading <= phSenseUB;
								});								
								ph4Points = ph4Points.filter(function(d) {
									return +d.reading <= phSenseUB;
								});

//Create Data Scales
//Create Scales for pH
								var phxScale = d3.time.scale()
											.domain([rollingSelection, maxdate])
											.range([xPadding, width - xPadding]);

								var phyScale = d3.scale.linear()
											.domain([phSenseLB, phSenseUB])
											.range([h - yPadding, yPadding]);

//Design Axis for pH
								var phxAxis = d3.svg.axis()
											.ticks(xAxisTicks)
											.orient("bottom")
											.scale(phxScale);

								var phyAxis = d3.svg.axis()
											.ticks(yAxisTicks)
											.orient("left")
											.scale(phyScale);

//Create SVG pH canvas element
								var phCanvas = d3.select("#phArea")
											.append("svg")
											.attr("id", "phspace")
											.attr("width", w)
											.attr("height", h)
											.append("g")
											.attr("transform", "translate(0, 0)");

//Build Tooltips for pH
								var phTip1 = d3.tip()
								.attr('class', 'd3-tip1')
								.offset([-10, 0])
								.html(function(d) {
									return "<strong>Time: </strong>" + d.time + "<br /><strong>Reading: </strong>" + d.reading + "<br /><strong>ID: </strong>" + d.id;
								})

								var phTip2 = d3.tip()
								.attr('class', 'd3-tip2')
								.offset([-10, 0])
								.html(function(d) {
									return "<strong>Time: </strong>" + d.time + "<br /><strong>Reading: </strong>" + d.reading + "<br /><strong>ID: </strong>" + d.id;
								})

								var phTip3 = d3.tip()
								.attr('class', 'd3-tip3')
								.offset([-10, 0])
								.html(function(d) {
									return "<strong>Time: </strong>" + d.time + "<br /><strong>Reading: </strong>" + d.reading + "<br /><strong>ID: </strong>" + d.id;
								})

								var phTip4 = d3.tip()
								.attr('class', 'd3-tip4')
								.offset([-10, 0])
								.html(function(d) {
									return "<strong>Time: </strong>" + d.time + "<br /><strong>Reading: </strong>" + d.reading + "<br /><strong>ID: </strong>" + d.id;
								})

//Activate Tooltips for pH
								phCanvas.call(phTip1);
								phCanvas.call(phTip2);
								phCanvas.call(phTip3);
								phCanvas.call(phTip4);

//Line Function
								var lineGen = d3.svg.line()
								    .x(function(d) {
								        return phxScale(timeParser(d.time));
								    })
								    .y(function(d) {
								        return phyScale(d.reading);
								    });	    

//Handle Graphing pH1
		//Draw pH1 Line
								phCanvas.append('svg:path')
									.attr('d', lineGen(ph1Points))
									.attr("class", "phline")
									.attr("id", "ph1line")
									.attr('stroke', ph1Color)
									.attr('stroke-width', lineStroke)
									.attr('fill', 'none');
		//Create pH1 plot dots
								ph1 = phCanvas.selectAll("circle.ph1Points")
									   	.data(ph1Points)
									   	.enter()
								   	.append("circle")
									    .attr("class", "ph1points")
									    .style("fill", ph1Color)
									    .attr("cx", function(d) {
									   		return (phxScale(timeParser(d.time)));
									    })
									    .attr("cy", function(d) {
									   		return (phyScale(d.reading));
									    })
									    .attr("r", circleSize)
									    .on('mouseover', phTip1.show)  
   									    .on('mouseout', phTip1.hide);

//Handle Graphing pH2
		//Draw pH2 Line
								phCanvas.append('svg:path')
									.attr('d', lineGen(ph2Points))
									.attr("class", "phline")
									.attr("id", "ph2line")
									.attr('stroke', ph2Color)
									.attr('stroke-width', lineStroke)
									.attr('fill', 'none');
		//Create pH2 plot dots
								ph2 = phCanvas.selectAll("circle.ph2Points")
									   	.data(ph2Points)
									   	.enter()
								   	.append("circle")
									    .attr("class", "ph2points")
									    .style("fill", ph2Color)
									    .attr("cx", function(d) {
									   		return (phxScale(timeParser(d.time)));
									    })
									    .attr("cy", function(d) {
									   		return (phyScale(d.reading));
									    })
									    .attr("r", circleSize)
									    .on('mouseover', phTip2.show)  
   									    .on('mouseout', phTip2.hide);
   								
//Handle Graphing pH3
		//Draw pH3 Line
								phCanvas.append('svg:path')
									.attr('d', lineGen(ph3Points))
									.attr("class", "phline")
									.attr("id", "ph3line")
									.attr('stroke', ph3Color)
									.attr('stroke-width', lineStroke)
									.attr('fill', 'none');
		//Create pH3 plot dots
								ph3 = phCanvas.selectAll("circle.ph3Points")
									   	.data(ph3Points)
									   	.enter()
								   	.append("circle")
									    .attr("class", "ph3points")
									    .style("fill", ph3Color)
									    .attr("cx", function(d) {
									   		return (phxScale(timeParser(d.time)));
									    })
									    .attr("cy", function(d) {
									   		return (phyScale(d.reading));
									    })
									    .attr("r", circleSize)
									    .on('mouseover', phTip3.show)  
   									    .on('mouseout', phTip3.hide);

//Handle Graphing pH4
		//Draw pH4 Line
								phCanvas.append('svg:path')
									.attr('d', lineGen(ph4Points))
									.attr("class", "phline")
									.attr("id", "ph4line")
									.attr('stroke', ph4Color)
									.attr('stroke-width', lineStroke)
									.attr('fill', 'none');
		//Create pH4 plot dots
								ph4 = phCanvas.selectAll("circle.ph4Points")
									   	.data(ph4Points)
									   	.enter()
								   	.append("circle")
									    .attr("class", "ph4points")
									    .style("fill", ph4Color)
									    .attr("cx", function(d) {
									   		return (phxScale(timeParser(d.time)));
									    })
									    .attr("cy", function(d) {
									   		return (phyScale(d.reading));
									    })
									    .attr("r", circleSize)
									    .on('mouseover', phTip4.show)  
   									    .on('mouseout', phTip4.hide);

//Draw pH axis
								phCanvas.append("g")
											.attr("class", "xAxis")
											.attr("transform", "translate(0, 480)")
											.call(phxAxis)
										.append("text")
											.attr("x", (w - xPadding*3))
											.attr("y", -5)
											.text("Reading Time: ");

								phCanvas.append("g")
											.attr("class", "yAxis")
											.attr("transform", "translate(" + xPadding2 + ", 0)")
											.call(phyAxis)
										.append("text")
											.attr("x", 0)
											.attr("y", yPadding)
											.text("Reading Value:");

//Function to make the graphs resize to the window automatically
								d3.select(window).on('resize', resize); 

								function resize() {
								    // update width
								    width = parseInt(d3.select('#phspace').style('width'), 10);
								    width = width - margin.left - margin.right;

								    // resize the chart
								    phxScale.range([0, width]);
								    d3.select(chart.node().parentNode)
								        .style('height', (y.rangeExtent()[1] + margin.top + margin.bottom) + 'px')
								        .style('width', (width + margin.left + margin.right) + 'px');

								    phCanvas.selectAll('rect.background')
								        .attr('width', width);

								    phCanvas.selectAll('rect.percent')
								        .attr('width', function(d) { return x(d.percent); });

								    // update axes
								    phCanvas.select('.x.axis.top').call(xAxis.orient('top'));
								    phCanvas.select('.x.axis.bottom').call(xAxis.orient('bottom'));

								}
//Building Aggregate Data Information Box
/*								phinfoBox = d3.select("#phArea").append("div")
											.attr("class", "aggBox")
											.attr("id", "phaggBox")
											.append("p").text("test box");
*/
							})
						})
					})
				})   
				</script>
			</div>






			<div class="row" id="ecArea">
				<p>EC Graph</p>
			</div>
			<div class="row" id="doArea">
				<p>DO Graph</p>
			</div>
			<div class="row" id="wtempArea">
				<p>Water Temperature Graph
			</div>
			<div class="row" id="atempArea">
				<p>Air Temperature Graph</p>
			</div>
			<div class="row" id="lightArea">
				<p>Light Graph</p>
			</div>
			<div class="row" id="humidityArea">
				<p>Humidity Graph</p>
			</div>
			<div class="row" id="co2Area">
				<p>CO<sub>2</sub> Graph</p>
			</div>

		</div>
	</body>
</html>